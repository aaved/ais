#!/usr/bin/env bash
#
# ais - An arch install script based on installation guide.
# https://github.com/flame-0/ais

read -r -p 'Disk (example: /dev/sda): ' DISK
read -r -p "Swap size for $DISK (examples: +512M, +1G): " SWAP_SIZE
read -r -p 'Timezone (examples: Europe/London, Asia/Tokyo): ' TIMEZONE
read -r -p 'Hostname (example: arch): ' HOSTNAME

# Set the root password
while true; do
    read -s -r -p 'Root password: ' ROOT_PASSWORD0
    echo
    read -s -r -p 'Retype password: ' ROOT_PASSWORD1
    echo
    [[ "$ROOT_PASSWORD0" = "$ROOT_PASSWORD1" ]] && break
    echo 'Passwords do not match.'
done

# Add user and its password
read -r -p 'Username: ' USERNAME
while true; do
    read -s -r -p "Password for $USERNAME: " USER_PASSWORD0
    echo
    read -s -r -p 'Retype password: ' USER_PASSWORD1
    echo
    [[ "$USER_PASSWORD0" = "$USER_PASSWORD1" ]] && break
    echo 'Passwords do not match.'
done
echo

BASE_PACKAGES=(
    base
    linux
    linux-firmware
)

OTHER_PACKAGES=(
    base-devel
    grub
    nano
    networkmanager
    ntfs-3g
    os-prober
    xdg-user-dirs
    xf86-video-amdgpu
    xorg
    xorg-xinit
)

# Update the system clock
system_clock() {
    timedatectl set-ntp true
}

# Partition the disks
partition_disk() {
    # Standard input (stdin) for fdisk command:
    # o          Create an empty DOS partition table
    # n          Add a new partition for swap
    # p          Partition type: Primary
    # 1          Partition number: 1
    #            First sector: default
    # $SWAP_SIZE Last sector (Suggested size: More than 512 MiB): +512M/+1G/+2G
    # t          Change the partition type
    # 82         Hex code or alias: 82 (Linux swap / Solaris) or swap
    # n          Add a new partition for root
    # p          Partition type: Primary
    # 2          Partition number: 2
    #            First sector: default
    #            Last sector (Suggested size: Remainder of the device): default
    # a          Toggle a bootable flag
    # 2          Partition number: 2
    # w          Write the table to disk
    echo -e "o\nn\np\n1\n\n$SWAP_SIZE\nt\n82\nn\np\n2\n\n\na\n2\nw\n" | fdisk "$DISK"
}

# Format the partitions
format_partition() {
    mkfs.ext4 "${DISK}2"
    mkswap "${DISK}1"
}

# Mount the file systems
file_system() {
    mount "${DISK}2" /mnt
    swapon "${DISK}1"
}

# Install essential packages
install_package() {
    pacstrap /mnt "${BASE_PACKAGES[@]}" "${OTHER_PACKAGES[@]}"
}

# Fstab
generate_fstab() {
    genfstab -U /mnt >> /mnt/etc/fstab
}

# Chroot phase
# Time zone
time_zone() {
    ln -sf /usr/share/zoneinfo/"$TIMEZONE" /mnt/etc/localtime
    arch-chroot /mnt hwclock --systohc
}

# Localization
generate_locale() {
    sed -i '/#en_US.UTF-8/s/^#//g' /mnt/etc/locale.gen
    arch-chroot /mnt locale-gen
    echo 'LANG=en_US.UTF-8' > /mnt/etc/locale.conf
}

# Network configuration
network_configuration() {
    echo "$HOSTNAME" > /mnt/etc/hostname
    {
        echo '127.0.0.1 localhost'
        echo '::1       localhost'
        echo "127.0.1.1 $HOSTNAME.localdomain $HOSTNAME"
    } >> /mnt/etc/hosts
    arch-chroot /mnt systemctl enable NetworkManager.service
}

# Root password
root_password() {
    echo root:"$ROOT_PASSWORD1" | chpasswd --root /mnt
}

# Boot loader
boot_loader() {
    arch-chroot /mnt grub-install --target=i386-pc "$DISK"
    arch-chroot /mnt grub-mkconfig -o /boot/grub/grub.cfg
}

# Add user
add_user() {
    arch-chroot /mnt useradd -m -G wheel "$USERNAME"
    echo "$USERNAME":"$USER_PASSWORD1" | chpasswd --root /mnt
}

# User permissions
user_permission() {
    echo "$USERNAME ALL=(ALL) ALL" >> /mnt/etc/sudoers.d/"$USERNAME"
}

# Reboot
reboot_machine() {
    umount -R /mnt
    echo 'Installation complete. You may now reboot the machine.'
}

main() {
    set -euo pipefail
    system_clock
    partition_disk
    format_partition
    file_system
    install_package
    generate_fstab
    time_zone
    generate_locale
    network_configuration
    root_password
    boot_loader
    add_user
    user_permission
    reboot_machine
}

main
